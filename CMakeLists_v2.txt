cmake_minimum_required(VERSION 3.16)
set(CMAKE_DISABLE_SOURCE_CHANGES ON)
set(CMAKE_DISABLE_IN_SOURCE_BUILD ON)
SET(CMAKE_BUILD_TYPE Debug)

project(shrg_graph_parser)

add_definitions(
    -D_GLIBCXX_USE_CXX11_ABI=0
    -DBOOST_NO_CXX98_FUNCTION_BASE
    -DBOOST_ALLOW_DEPRECATED_HEADERS
    -DBOOST_NO_CXX11_TEMPLATE_ALIASES
)

# Compiler flags
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC -include functional")
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Options
option(ENABLE_PROFILING "Enable gprof" OFF)
option(ENABLE_PARSER_CHECK "Enable parser check" OFF)
option(USE_SYSTEM_BOOST "Use system FindBoost.cmake" OFF)
option(USE_PYTHON "Compile python interface with pybind11" OFF)
option(BUILD_UTILITIES "Build utility executables" ON)

if(ENABLE_PROFILING)
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -pg")
endif()

if(ENABLE_PARSER_CHECK)
  add_definitions( -DSHRG_PARSER_CHECK )
endif()

# Boost configuration
if(USE_SYSTEM_BOOST)
  find_package(Boost REQUIRED)
  message(STATUS "Boost_INCLUDE_DIRS = ${Boost_INCLUDE_DIRS}")
  include_directories(${Boost_INCLUDE_DIRS})
else()
  message(STATUS "Boost_INCLUDE_DIRS = ${PROJECT_SOURCE_DIR}/third-party/")
  include_directories(${PROJECT_SOURCE_DIR}/third-party/)
endif()

# Include directories
include_directories(
    ${Boost_INCLUDE_DIRS}
    ${PROJECT_SOURCE_DIR}/third-party/sparsehash-c11
    ${PROJECT_SOURCE_DIR}/third-party/sparsehash-c11/sparsehash
    ${PROJECT_SOURCE_DIR}/src
)
include_directories(/Library/Developer/CommandLineTools/usr/include/c++/v1)

# ===== CORE LIBRARY =====

# Core SHRG graph parser library
file(GLOB GRAPH_PARSER_SOURCES "src/graph_parser/*.cpp")
add_library(shrg STATIC
    "src/include/bleu.cpp"
    ${GRAPH_PARSER_SOURCES}
)
set_target_properties(shrg PROPERTIES POSITION_INDEPENDENT_CODE TRUE)

# ===== EM FRAMEWORK V2 LIBRARY =====

# EM Framework V2 (New refactored framework)
file(GLOB EM_FRAMEWORK_V2_SOURCES
    "src/em_framework_v2/*.cpp"
)

add_library(em_framework_v2 STATIC
    ${EM_FRAMEWORK_V2_SOURCES}
)
target_link_libraries(em_framework_v2 PRIVATE shrg)
target_include_directories(em_framework_v2 PUBLIC src/em_framework_v2)

# Legacy EM framework (for compatibility with existing utilities)
file(GLOB EM_LEGACY_SOURCES
    "src/em_framework/find_derivations.cpp"
    "src/em_framework/em_base.cpp"
    "src/em_framework/em.cpp"
    "src/em_framework/em_utils.cpp"
    "src/em_framework/em_batch.cpp"
    "src/em_framework/em_viterbi.cpp"
    "src/em_framework/em_online.cpp"
    "src/em_framework/em_evaluate/eval_deriv.cpp"
)
add_library(em_legacy STATIC
    ${EM_LEGACY_SOURCES}
    "src/manager.cpp"
)
target_link_libraries(em_legacy PRIVATE shrg)

# ===== EM FRAMEWORK V2 EXECUTABLES =====

# Main EM V2 experiment runner
add_executable(run_em_v2
    "src/run_em_v2.cpp"
)
target_link_libraries(run_em_v2 PRIVATE em_framework_v2 em_legacy shrg)

# Individual EM V2 algorithm runners
add_executable(run_full_em_v2
    "src/run_full_em_v2.cpp"
)
target_link_libraries(run_full_em_v2 PRIVATE em_framework_v2 em_legacy shrg)

add_executable(run_batch_em_v2
    "src/run_batch_em_v2.cpp"
)
target_link_libraries(run_batch_em_v2 PRIVATE em_framework_v2 em_legacy shrg)

add_executable(run_viterbi_em_v2
    "src/run_viterbi_em_v2.cpp"
)
target_link_libraries(run_viterbi_em_v2 PRIVATE em_framework_v2 em_legacy shrg)

add_executable(run_online_em_v2
    "src/run_online_em_v2.cpp"
)
target_link_libraries(run_online_em_v2 PRIVATE em_framework_v2 em_legacy shrg)

# EM V2 coordinator runner
add_executable(run_em_coordinator
    "src/run_em_coordinator.cpp"
)
target_link_libraries(run_em_coordinator PRIVATE em_framework_v2 em_legacy shrg)

# EM V2 evaluation runner
add_executable(run_em_v2_evaluation
    "src/run_em_v2_evaluation.cpp"
)
target_link_libraries(run_em_v2_evaluation PRIVATE em_framework_v2 em_legacy shrg)

# ===== UTILITY EXECUTABLES =====

if(BUILD_UTILITIES)
    # Generation utility
    add_executable(generate
        "src/generate.cpp"
    )
    target_link_libraries(generate PRIVATE em_legacy shrg)

    # Evaluation utility
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/evaluate.cpp")
        add_executable(evaluate
            "src/evaluate.cpp"
        )
        target_link_libraries(evaluate PRIVATE em_legacy shrg)
    endif()

    # Sentence processing utilities
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/get_original_sentences.cpp")
        add_executable(add_original_sentences
            "src/get_original_sentences.cpp"
        )
        target_link_libraries(add_original_sentences PRIVATE em_legacy shrg)
    endif()

    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/get_lemma_sentences.cpp")
        add_executable(get_lemma_sentences
            "src/get_lemma_sentences.cpp"
        )
        target_link_libraries(get_lemma_sentences PRIVATE em_legacy shrg)
    endif()
endif()

# ===== DEVELOPMENT AND DEBUG TOOLS =====

# Parser debugging tools (optional - only if source files exist)
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/shrg_parser.cpp")
    add_executable(shrg_parser
        "src/shrg_parser.cpp"
    )
    target_link_libraries(shrg_parser PRIVATE shrg)
endif()

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/check_parser.cpp")
    add_executable(check_parser
        "src/check_parser.cpp"
    )
    target_link_libraries(check_parser PRIVATE shrg)
endif()

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/treewidth.cpp")
    add_executable(treewidth
        "src/treewidth.cpp"
    )
    target_link_libraries(treewidth PRIVATE shrg)
endif()

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/test.cpp")
    add_executable(manager_test
        "src/test.cpp"
    )
    target_link_libraries(manager_test PRIVATE em_legacy shrg)
endif()

# ===== LEGACY EM EXECUTABLES =====

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/run_batch_em.cpp")
    add_executable(run_batch_em
        "src/run_batch_em.cpp"
    )
    target_link_libraries(run_batch_em PRIVATE em_legacy shrg)
endif()

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/run_em_viterbi.cpp")
    add_executable(run_em_viterbi
        "src/run_em_viterbi.cpp"
    )
    target_link_libraries(run_em_viterbi PRIVATE em_legacy shrg)
endif()

if (EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/run_online_em.cpp")
    add_executable(run_online_em
        "src/run_online_em.cpp")
    target_link_libraries(run_online_em PRIVATE em_legacy shrg)
endif()

# ===== PYTHON INTERFACE (Optional) =====

if(USE_PYTHON)
    find_package(Python 3 COMPONENTS Interpreter Development REQUIRED)

    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/python")
        file(GLOB PYTHON_SOURCES "src/python/*.cpp")

        # Python binding library
        add_library(pyshrg SHARED ${PYTHON_SOURCES})
        target_link_libraries(pyshrg PRIVATE em_framework_v2 em_legacy shrg ${Python_LIBRARIES})
        target_include_directories(pyshrg PRIVATE ${Python_INCLUDE_DIRS})

        # Generate Python stubs
        add_custom_target(pyshrg_stubs
            "stubgen" "-o" "typings" "-m" "pyshrg"
            DEPENDS pyshrg
            WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
        )
    endif()
endif()
# ===== BUILD SUMMARY =====

message(STATUS "=== Build Configuration Summary ===")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Profiling enabled: ${ENABLE_PROFILING}")
message(STATUS "Parser check enabled: ${ENABLE_PARSER_CHECK}")
message(STATUS "Python interface: ${USE_PYTHON}")
message(STATUS "Using system Boost: ${USE_SYSTEM_BOOST}")
message(STATUS "Build utilities: ${BUILD_UTILITIES}")
message(STATUS "====================================")

message(STATUS "")
message(STATUS "Legacy EM targets:")
message(STATUS "  run_batch_em               - Legacy Batch EM algorithm")
message(STATUS "  run_em_viterbi             - Legacy Viterbi EM algorithm")
message(STATUS "  run_online_em              - Legacy Online EM algorithm")

message(STATUS "")
message(STATUS "Evaluation targets:")
message(STATUS "  run_comprehensive_evaluation - Comprehensive evaluation runner")